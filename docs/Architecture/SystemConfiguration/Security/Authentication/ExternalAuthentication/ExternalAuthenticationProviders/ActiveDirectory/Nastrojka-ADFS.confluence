---
layout: default
title: "Настройка ADFS"
position: 1
categories: 
tags: 
---

<ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">1. Добавление доверенной стороны</ac:parameter><ac:rich-text-body><p>Служба ADFS реализует модель аутентификации на основе утверждений (<a href="http://msdn.microsoft.com/en-us/library/ee517291.aspx">Claims-Based Identity Model</a>). Соответственно сама служба ADFS выступает в роли сервиса маркеров безопасности (S<span style="color: rgb(0,0,0);">ecurity Token Service, STS) и </span>предоставляет возможность зарегистрировать защищаемый ресурс (в терминах спецификации <a href="http://msdn.microsoft.com/en-us/library/bb498017.aspx" style="line-height: 1.4285715;">WS-Federation</a> - <span style="color: rgb(42,42,42);">realm) и доверенную сторону (Relying Party Trust, RP), которой будут переданы маркеры безопасности (S<span style="color: rgb(0,0,0);">ecurity Tokens</span>) в случае успешной аутентификации. Для регистрации защищаемого ресурса и доверенной стороны в ADFS нужно запустить консоль &quot;AD FS Management&quot;, выбрать раздел &quot;AD FS / Trust Relationships / <span style="color: rgb(42,42,42);">Relying Party Trusts</span>&quot; и выполнить действие &quot;Add <span style="color: rgb(42,42,42);">Relying Party Trust...</span>&quot;. Эти действия приведут к запуску мастера &quot;<span style="color: rgb(42,42,42);">Add </span><span style="color: rgb(42,42,42);">Relying Party Trust Wizard</span>&quot;, который позволяет сделать необходимые настройки. Ниже наглядно показан процесс добавления доверенной стороны с помощью мастера в Windows Server 2012 R2.</span></p><p>&nbsp;</p><p>1.&nbsp;Окно приветствия.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_01.png" /></ac:image></p><p>&nbsp;</p><p>2. Указать &quot;Enter data about the relying party manually&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_02.png" /></ac:image></p><p>&nbsp;</p><p>3. Указать отображаемое имя доверенной стороны (например, &quot;InfinniPlatform&quot;).</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_03.png" /></ac:image></p><p>&nbsp;</p><p>4. Указать &quot;AD FS Profile&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_04.png" /></ac:image></p><p>&nbsp;</p><p>5. Оставить все как есть и нажать &quot;Next&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_05.png" /></ac:image></p><p>&nbsp;</p><p>6. Указать адрес доверенной стороны для отправки маркеров безопасности в формате &quot;https://&lt;InfinniPlatform Server&gt;:&lt;Port&gt;/Auth/SignInExternalCallback&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_06.png" /></ac:image></p><p>&nbsp;</p><p>7. Добавить идентификатор ресурса &quot;https://InfinniPlatform&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_07.png" /></ac:image></p><p>&nbsp;</p><p>8. Указать &quot;I do not want to configure multi-factor athentication settings for this relying party trust at this time&quot;.</p><ac:structured-macro ac:name="note"><ac:rich-text-body><p>Этот шаг выполняется только для Windows Server 2012 с ADFS по умолчанию.</p></ac:rich-text-body></ac:structured-macro><p>&nbsp;</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_08.png" /></ac:image></p><p>&nbsp;</p><p>9. Выбрать &quot;Permit all users to access this relying party&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_09.png" /></ac:image></p><p>&nbsp;</p><p>10. <span>Оставить все как есть и нажать &quot;Next&quot;.</span></p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_10.png" /></ac:image></p><p>&nbsp;</p><p>11. Выбрать &quot;Open the Edit Claim Rules dialog for this relying party trust when the wizard closes&quot;.</p><p><ac:image><ri:attachment ri:filename="AddRelyingPartyTrust_11.png" /></ac:image></p><pre>    </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">2. Добавление публикуемых утверждений</ac:parameter><ac:rich-text-body><p>Если в конце выполнения предыдущего шага была выбрана настройка <span>&quot;Open the Edit Claim Rules dialog for this relying party trust when the wizard closes&quot;, откроется диалог настройки правил публикации утверждений (claims) для созданной доверенной стороны. Этот же диалог можно запустить, выбрав нужную доверенную сторону в разделе &quot;<span style="color: rgb(42,42,42);">AD FS / Trust Relationships / </span><span style="color: rgb(42,42,42);">Relying Party Trusts</span>&quot; и выполнив действие &quot;Edit Claim Rules...&quot;. <span style="color: rgb(42,42,42);">Ниже наглядно показан процесс добавления правил публикации утверждений с помощью мастера в Windows Server 2012 R2.</span></span></p><p>&nbsp;</p><p>1.&nbsp;На вкладке &quot;Issuance Transform Rules&quot; нажать кнопку &quot;Add Rule...&quot;.</p><p><ac:image><ri:attachment ri:filename="EditClaimRules_01.png" /></ac:image></p><p>&nbsp;</p><p>2. Выбрать шаблон &quot;Send LDAP Attributes as Claims&quot;.</p><p><ac:image><ri:attachment ri:filename="EditClaimRules_02.png" /></ac:image></p><p>&nbsp;</p><p>3. Задать имя правила &quot;RequiredClaims&quot;, выбрать хранилище &quot;Active Directory&quot; и указать правила отображения: &quot;SAM-Account-Name &rarr; nameidentifier&quot;, <span>&quot;SAM-Account-Name &rarr; name&quot;, <span>&quot;E-Mail-Addresses &rarr; emailaddress&quot;.</span></span></p><p>Вариант для русифицированной Windows Server:</p><p><ac:image><ri:attachment ri:filename="EditClaimRules_03.png" /></ac:image></p><p>Вариант для англоязычной Windows Server:</p><p><ac:image><ri:attachment ri:filename="image2014-12-13-12123.png" /></ac:image></p><ac:structured-macro ac:name="note"><ac:rich-text-body><p>Клэйм distinguishedName имеет Outgoing Claim Type = &quot;<a href="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/x500distinguishedname">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/x500distinguishedname</a>&quot; (без кавычек). Через него ADFS сообщит информацию об организационной единице (ogranizational unit), к которой принадлежит пользователь.</p></ac:rich-text-body></ac:structured-macro><p>&nbsp;</p><p>&nbsp;</p><p>4. Нажать кнопку &quot;Apply&quot; и закрыть диалог.</p><p><ac:image><ri:attachment ri:filename="EditClaimRules_04.png" /></ac:image></p><pre>    </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">3. Настройка ADFS для работы с браузерами, отличными от IE</ac:parameter><ac:rich-text-body><ol><li>На сервере ADFS открыть консоль IIS.</li><li>Найти приложение adfs &gt; ls.</li><li>Открыть Authentication настройки для Windows Authentication.</li><li>Отключить Extended Protection.<br /><ac:image><ri:attachment ri:filename="image2014-12-13-11574.png" /></ac:image></li><li>В некоторых случаях (например, для FF &gt; 30) необходимо отключить Windows Authentication и включить Basic Authentication (подробнее см. <a href="http://stackoverflow.com/questions/24245357/unable-to-log-in-to-adfs-using-firefox-30-0">здесь</a>).</li></ol></ac:rich-text-body></ac:structured-macro>