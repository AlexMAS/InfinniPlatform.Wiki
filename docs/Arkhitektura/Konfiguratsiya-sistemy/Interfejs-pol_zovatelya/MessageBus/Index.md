---
layout: default
title: "MessageBus"
position: 17
categories: 
tags: 
---

Асинхронная шина сообщений представления.

 

Асинхронная шина сообщений создается для каждого экземпляра представления (см. [[View]]) и предоставляет инфраструктуру для обмена сообщениями (событиями) между различными элементами этого представления (как визуальными, так и не визуальными). Еще раз акцентирую внимание: во-первых, шина - асинхронная; во-вторых, создается для каждого экземпляра представления, а не для приложения в целом. Первое значит, что отправка сообщений осуществляется асинхронно, то есть отправитель не дожидается момента окончания обработки сообщения. Второе значит, что обмен сообщениями в рамках экземпляра одного представления никак не влияет на экземпляры других представлений. Ниже определен API шины сообщений.

   

|Name|Description|
|----|-----------|
|Send(string messageType, any messageBody)|Отправляет сообщение синхронно:* messageType - тип сообщения;
* messageBody - тело сообщения.

|
|SendAsync(string messageType, any messageBody)|Отправляет сообщение асинхронно:* messageType - тип сообщения;
* messageBody - тело сообщения.

|
|Subscribe(string messageType, function<any> messageHandler)|Подписывает на сообщения:* messageType - тип сообщения;
* messageHandler - обработчик сообщения.

|

 

Каждый элемент представления (как визуальный, так и не визуальный) может выступать в качестве источника и/или в качестве подписчика на сообщения. Когда именно элемент будет осуществлять отправку сообщений, зависит от логики работы самого элемента. Когда именно элемент обработает поступившее сообщение, также зависит от элемента. Иначе говоря, момент отправки и момент окончания обработки сообщения в общем случае не детерминирован (возможно, сообщение никогда не будет отправлено; возможно, сообщение никогда не будет обработано), единственное, что гарантирует шина сообщений - доставку сообщения от источника всем существующим подписчикам.

 

Для отправки сообщения необходимо вызвать метод SendAsync() и передать два параметра: тип сообщения (messageType) и тело сообщения (messageBody). Получив такой запрос, шина сообщений осуществляет поиск всех подписчиков, заинтересованных в получении сообщения с заданным типом (messageType), после чего вызывает соответствующие обработчики сообщений, передавая в каждый из них указанное тело сообщения (messageBody). Для подписки на сообщение необходимо вызвать метод Subscribe() и передать два параметра: тип сообщения (messageType) и указатель на функцию обработки сообщения (messageHandler). При появлении сообщения с заданным типом (messageType) шина сообщений вызовет данный обработчик сообщения, передав ему тело сообщения. Естественно, что каждому типу сообщения (messageType) жестко соответствует определенная структура тела сообщения (messageBody) - см. разделы [[MessageType]] и [[MessageBody]]. В общем случае порядок регистрации обработчиков сообщений никак не связан с порядком их выполнения. Последнее значит, что между обработчиками сообщений не должно быть функциональной зависимости.

 

```
View currentView;
 
// Получение ссылки на шину сообщений текущего представления
var exchange = currentView.GetExchange();
 
// Подписка на сообщение с типом Event1
exchange.Subscribe("Event1", function(messageBody) {
	alert("Event1: " + messageBody.Value);
});
 
// Публикация сообщения с типом Event1
exchange.SendAsync("Event1", { Value: 123 });
```

 

 

