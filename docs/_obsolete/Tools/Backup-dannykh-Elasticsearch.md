---
layout: doc
title: "Backup данных Elasticsearch"
position: 
categories: 
tags: 
---

## Введение

Для создания резервных копий данных, хранящихся в кластере Elasticsearch, разработаны две консольные [[утилиты|ElasticsearchBackup.zip]]:

snapshoter - утилита для создания полноценных резервных копий данных, хранящихся в индексах Elasticsearch. В основе реализации операций лежит встроенный в Elasticsearch механизм [snapshots](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-snapshots.html)exporter - экспорт/импорт определенных документов из одного индекса. При экспорте происходит выборка данных из индекса по заданному критерию, после чего найденные документы сохраняются в json формате. Для работы утилит на компьютере должен быть установлен .Net Framework версии 4.5.

## Использование утилиты snapshoter

Применение утилиты рекомендуется в том случае, если необходимо сделать полную резервную копию нескольких (или всех) индексов кластера. Утилита позволяет произвести четыре операции:

Создать хранилище резервных копийПросмотреть доступные резервные копии хранилищаСоздать резервную копию в хранилищеВосстановить резервную копию из хранилищаОписание аргументов утилиты:

|Имя параметра|Описание|Обязательность|
|-------------|--------|--------------|
|repository|Имя хранилища резервных копий|да|
|operation|Тип операции:CreateRepository = 1GetSnapshots = 2CreateSnapshot = 3RestoreSnapshot = 4|да|
|parameter|Параметр операции, зависящий от значения параметра operation.Для операции CreateRepository параметр должен содержать путь к хранилищу. Для операций CreateSnapshot и RestoreSnapshot параметр должен содержать имя резервной копии. Дополнительнок имени резервной копии можно указать любое количество индексов, которые необходимо сохранить. Например, backupname.document.patient (backupname - имя резервной копии, document и patient - имена индексов). Если имена индексов не указаны, в резервной копии будут сохранены все имеющиеся индексы.|нет|

Рассмотрим применение этих операций на конкретном примере. Допустим, мы собираемся хранить резервные копии данных elasticsearch в каталоге "C:\elasticsearch-1.1.0\restore". Создаём новое хранилище c именем backup путем запуска консольной утилиты со следующими аргументами:

```
snapshoter backup 1 "C:\elasticsearch-1.1.0\restore"
```

В случае, если хранилище успешно создано, утилита выдаст ответ: "Repository backupr creation result: success"

Далее можно создать резервную копию в хранилище backup:

```
snapshoter backup 3 snapshotname.patient
```

Операция выполняется синхронно и может занять некоторое время. После завершения создания резервной копии, будет показано сообщение: Snapshort snapshotname creation result: success.

Посмотреть список резервных копий, расположенных в хранилище, можно следующим образом:

```
snapshoter backup 2 
```

Ответ на запрос приходит в следующей форме:

Shapshot: snapshotname (created - 02.06.2014 15:09:56, state - SUCCESS)  
Shapshot: snapshot2 (created - 02.06.2014 15:24:00, state - SUCCESS)  
Shapshot: snapshot3 (created - 02.06.2014 15:27:07, state - SUCCESS)

Восстановить данные по резервной копии можно следующим образом:

```
snapshoter backup 4 snapshotname.patient
```

По окончании операции будет выдано сообщение: Snapshort snapshotname restoring result: success

## Использование утилиты exporter

Утилита поддерживает следующие операции: 

Экспортировать содержимое одного или всех типов из индекса в архивИмпортировать данные из архиваСкорректировать маппинг для определенного типаОписание аргументов утилиты:

 

|Имя параметра|Описание|Обязательность|
|-------------|--------|--------------|
|operation|Тип операции:Export = 1Import = 2MappingCorrection = 3|да |
|archive|Имя архива, в котором будут сохранены данные при экспорте или из которого будут взяты данные при импорте.Расширение не указывается (расширение .zip будет добавлено автоматически)|да|
|index|Имя индекса, из которого будут взяты данные при экспорте или куда будут помещены данные при импорте|да|
|type|Имя типа в индексе для экспорта данных. Если имя типа индекса не указано или имеет значение "all",будут проэкспортированы все типы из индекса. Параметр используется только для операции экспорта.|нет|
|datafilter|Имя файла, в котором содержится описание фильтра данных в формате [Query DSL](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-filters.html).Экспортироваться будут только те документы, которые удовлетворяют условиям фильтра. Если параметрне указан, будут проэкспортированы все документы.Пример фильтра (отбор документов с идентификатором "test_1"):```
{
   "filtered":{
      "filter":{
         "term":{
            "Id":"test_1"
         }
      }
   }
}
```

Если тип операции равен MappingCorrection, в качестве DataFilter передается полный путь к свойству, которое необходимо удалить из маппинга.Например: Patient.LastName|нет|

 

Рассмотрим применение этих операций на конкретном примере. Допустим, мы собираемся экспортировать документы, удовлетворяющие фильтру из файла "query.json", из всех типов индекса classifierstorage в архив "test_archive.zip". Для этого запускаем утилиту exporter со следующими аргументами:

```
exporter 1 test_archive classifierstorage all query.json
```

Далее проимпортируем содержимое полученного архива в индекс classifierstorage_clone:

```
exporter 2 test_archive  classifierstorage_clone
```

Применение данной утилиты рекомендуется в том случае, если нужно экспортировать данные из индекса с использованием фильтра. Во всех остальных случаях рекомендуется использовать утилиту snapshoter.

Пример корректировки маппинга:

```
exporter 3 test_archive iemk patient Name.LastName
```

