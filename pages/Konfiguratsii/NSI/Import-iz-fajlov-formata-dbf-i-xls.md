---
layout: default
title: Импорт из файлов формата dbf и xls
position: 
categories: 
tags: 
---

# Описание основного бизнес-процесса

 В рамках сервиса НСИ предусмотрена процедура  добавления (обновления) справочников посредством импорта. При импорте в НСИ создается новый справочник с уникальным идентификатором.Новый справочник создается и в случае импорта новой версии справочника. В этом случает новую версию справочника необходимо относить к определенной группе справочников с одинаковым уникальным идентификатором. 

Наименование справочника, создаваемого в НСИ должно выглядеть следующим образом: <CodeSystem>_<CodeSystemVersion>

Где

CodeSystem – OID справочника (уникальный идентификатор справочника)

CodeSystemVersion – Версия справочника.Версию справочника необходимо указывать в формате натуральных чисел с несколькими порядками. Максимальное число порядков – 4. Например,  1.0, 1.0.1,  1.0.1.4 и т.д.

 

Импорт необходимо осуществлять из файлов следующих форматов:

*  Файлы формата dbf
*  Файлы формата xls

Файлы для импорта должны храниться локально.

# Требования к импортируемому файлу в формате dbf

 Для импорта файла в формате dbf на него не накладываются никакие требования и ограничения

# Требования к импортируемому файлу в формате xls

 Для импорта файла в формате xls на него накладываются следующие требования и ограничения:

* На ячейки не должны быть наложены никакие условия форматирования.
* Данные должны храниться только на 1 листе книги.
* Записи в листе должны начинаться с ячейки A1.
* Порядок столбцов должен строго соответствовать порядку элементов Entry в файле описания метаданных. 
* На листе не должно быть сгруппированных ячеек.

# Требования к описанию метаданных в формате xml

Для каждого импортируемого файла необходимо хранить файл  с описанием метаданных в формате xml. В файле метаданных содержится общее описание справочника и описание полей справочника.

** **

**Общее описание справочника**

Общее описание  справочника должно располагаться в корневом элементе Classifier и содержать следующие внутренние элементы:

* *CodeSystem – OID справочника (уникальный идентификатор справочника). Элемент обязателен.
* *CodeSystemVersion – Версия справочника. Версию справочника необходимо указывать в формате натуральных чисел с несколькими порядками. Максимальное число порядков – 4. Например,  1.0, 1.0.1,  1.0.1.4 и т.д. Элемент обязателен.
* *CodeSystemName – Наименование справочника, которое отображается для пользователя. Элемент обязателен.
* *CodeRef – Наименование ключевого поля (должно соответствовать значению атрибута name одного из внутренних элементов entry). Элемент обязателен.
* *DisplayNameRef – наименование поля, которое содержит отображаемую информацию. Элемент обязателен.
* ParentRef – наименование поля, которое выступает в качестве поля-родителя, если справочник поддерживает иерархическую структуру. Значения данного поля должно соответствовать значению ключевого поля, которое является родителем. Элемент не является обязательным

 

**Описание полей справочника.**

Описание полей справочника должно располагаться в элементе Entries  корневого элемента Classifier. Каждое поля является внутренним элементом для элемента Entries и носит наименование Entry. Порядок элементов Entry должен соответствовать порядку полей справочника. Для каждого внутреннего элемента (поля справочника) должны быть указаны следующие атрибуты:

* *name – наименование поля. Элемент обязателен.
* *caption – наименование поля, которое отображается для пользователя. Элемент обязателен.
* type – тип данных поля. Допустимые типы данных: date, string, number (пригоден для типов данных float и int), bool. Элемент не является обязательным. Если элемент не указан или имеет пустое значение, то тип данных по умолчанию – string.
* description – описание поля, если есть такая необходимость, элемент не является обязательным.

 

Ниже приведен пример описания справочника Анатомо-терапевтическо-химическая классификация в формате xml.

Пример:

<?xml version="1.0" encoding="UTF-8"?>

<Classifier>

            <CodeSystem>atx</CodeSystem>

            <CodeSystemVersion>2.2</CodeSystemVersion>

            <CodeSystemName>Анатомо-терапевтическо-химическая классификация</CodeSystemName>

  <CodeRef>recid</CodeRef>

             <DisplayNameRef>name</DisplayNameRef>

            <ParentRef>high</ParentRef>

             <Description>Международная система классификации лекарственных средств по их основному терапевтическому применению</Description>

  <Entries>

                           <Entry name="recid" caption="Уникальный идентификатор" type="int" description=""/>

                           <Entry name="code" caption="Код записи" type="string" description=""/>

                           <Entry name="name" caption="Название лекарственного средства" type="string" description=""/>

    <Entry name="latname" caption="Латинское название лекарственного средства" type="string" description=""/>

    <Entry name="num" caption="NUM" type="string" description=""/>

    <Entry name="high" caption="УИ родительской записи" type="int" description=""/>

 </Entries>

</Classifier>  


# Варианты использования

## Импорт из файлов формата xls и dbf

Импорт необходимо осуществлять для одного или нескольких справочников в формате xls или dbf.

Для запуска импорта необходимо запустить соответствующую утилиту, которая позволяет указать путь до импортируемого файла или группы файлов, а также узнать о результатах проведения импорта.

Для запуска импорта необходимо из командной строки запустить утилиту import:

>localimport street.dbf street.xml

Необходимо указать наименования импортируемого файла и наименования файла с описанием метаданных.

Запускается RESTсервис. Для сервиса необходимо передавать содержимое файлов (xml + dbf или xls) в формате Base64.

 При импорте осуществляется сопоставление версий справочников. Если в реестре НСИ есть справочник  с более поздней версией, импорт не производится.

 

Обработка исключительных ситуаций:

* Если значения обязательных атрибутов не заполнены, или они не соответствуют содержанию файла в формате xls или dbf импорт не производится (например, не заполнен элемент CodeSystemVersion).
* Если невозможно распознать файл-источник как  файл dbf или xls, импорт не производится.
* Если невозможно подключиться к базе данных или невозможно найти в ней нужную таблицу, импорт не производится.
* В случае возникновения выше и иных ошибок, они выводятся в лог стандартным для системы способом.

