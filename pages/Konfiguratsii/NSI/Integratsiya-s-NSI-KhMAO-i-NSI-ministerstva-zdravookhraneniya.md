---
layout: default
title: "Интеграция с НСИ ХМАО и НСИ министерства здравоохранения"
position: 
categories: 
tags: 
---

# Описание основного бизнес-процесса

 В рамках сервиса НСИ предусмотрена интеграция с НСИ ХМАО и НСИ министерства здравоохранения. Интеграции с сервисом НСИ ХМАО и НСИ министерства здравоохранения  предназначена для выполнения следующих функций:

* обновление справочников 
* добавление справочников 

 Интеграция заключается в импорте новых справочников и импорте новых версий уже существующих в системе справочников

* с сервиса [http://62.168.244.238:7001/MedvedWeb/Nsi?WSDL](http://62.168.244.238:7001/MedvedWeb/Nsi?WSDL)для НСИ ХМАО
* с сервиса [http://nsi.rosminzdrav.ru](http://nsi.rosminzdrav.ru/) для НСИ системы здравоохранения

В случае изменения, необходимо изменить путь к сервису и параметры авторизации в конфигурационном файле в формате xml отдельно для НСИ ХМАО и НСИ системы здравоохранения.

 При импорте в НСИ создается новый справочник с уникальным идентификатором. Новый справочник создается и в случае импорта новой версии справочника. В этом случает новую версию справочника необходимо относить к определенной группе справочников с одинаковым уникальным идентификатором. 

 Наименование справочника, создаваемого в НСИ должно выглядеть следующим образом: < CodeSystem >_< CodeSystemVersion >

Где

CodeSystem – OID справочника (уникальный идентификатор справочника)

CodeSystemVersion – Версия справочника. Версию справочника необходимо указывать в формате А.В, где А и В – натуральные числа в диапазоне от 0 до 999, А - главный номер версии, В - вспомогательный номер версии. Главный номер версии изменяется в случае изменения структуры справочника.  Например,  1.0, 1.1 и т.д.

# Варианты использования

## Интеграция с НСИ ХМАО

Интеграция с НСИ министерства здравоохранения осуществляется посредством  импорта новых справочников или новых версий уже имеющихся в реестре НСИ справочников посредством REST сервисов.

Для запуска импорта необходимо запустить соответствующую утилиту из командной строки:

* >externalimport –source hmao  - возвращает список всех имеющихся справочников
* >externalimport –source hmao OID1 OID2 – Добавляет новый справочник/версию справочника в реестр НСИ. Необходимо указать уникальный идентификатор импортируемого справочника или группы справочников. Для НСИ ХМАО подобным идентификатором выступает OID справочника. 

Например: >externalimport –source hmao 1.2.643.5.1.13.2.1.1.169 (Классификатор причин возникновения инвалидности**)**

За раз возможно импортировать не более 10 справочников. При импорте осуществляется сопоставление версий справочников. Если в реестре НСИ есть справочник  с более поздней версией, импорт не производится.

В общем виде сервис интеграции с НСИ ХМАО выглядит следующим образом:

Пользователь запрашивает с сервиса НСИ ХМАО полный перечень справочниковПользователь видит перечень справочниковЗадаются параметры импортаОтправляется запрос сервису НСИ ХМАО на получение данных заданного справочникаПроисходит добавление справочника в реестр НСИПользователь получает информацию о результате выполнения импорта.**Просмотр информации о результатах выполнения импорта**

Необходимо выводить в лог следующую информацию:

* о начале работы,
* о завершении работы
* о статусе завершения работы (с ошибками или нет).

**Обработка исключительных ситуаций:**

*        Если программа не смогла распознать введенные параметры или параметры введены некорректно, то команда не выполняется.
*        Если невозможно к базе данных или невозможно найти в ней нужную таблицу, импорт не производится  
*        В случае возникновения выше и иных ошибок, они выводятся в лог стандартным для системы способом.

Интеграция с сервисом НСИ ХМАО реализуется посредством указанных ниже методов:

Отправка запроса на получения полного перечня справочников

Программа отправляет запрос getRefBookList() к веб-сервису:

Веб-сервис возвращает список справочников в виде массива структур вида:

s_code – уникальный код справочника,

s_name – наименование справочника,

s_version –текущая версия справочника

Отображение перечня справочников, используемых в системе и требующих обновления

После получения полного списка справочников, программа обращается к регистру Справочники, устанавливает соответствие между данным списком и списком справочников, использующихся в системе, при этом сравнивая версию данных справочников.

В итоге пользователю в программе отображается таблица, которая содержит в себе информацию о:

* Справочнике, использующемся в системе, с указанием кода справочника
* Текущей версии справочника в системе
* О новой версии справочника, полученной с веб-сервиса

|Код справочника|Справочник|Текущая версия|Доступная версия|
| HST0002 |Справочник типов документов|1.0|1.1|

Задание параметров обновления

Получив информацию о справочниках, которые нужно обновить пользователь должен задать параметр обновления

Пример: /update: HST0002 (обновить справочник типов документов)

При этом Пользователь может

* Обновить все справочники, установив значение: 0
* Задать определенный перечень справочников для обновления, указав через запятую коды данных справочников

По умолчанию: <0> - обновить все справочники

После того, как был задан параметр обновления, программа формирует запросы к веб-сервису

long getRefBookParts(String code, String version) – возвращает количество частей справочника с кодом code, номер версии version.  Количество записей в части справочника от 1 до 500.

После получения количества частей записи формируется новый запрос

getRefBookPartial (String code, String version, int part) – возвращает массив записей справочника с кодом code, версии version, части part. Структура записи зависит от справочника.

## Интеграция с НСИ министерства здравоохранения

Интеграция с НСИ министерства здравоохранения осуществляется посредством  импорта новых справочников или новых версий уже имеющихся в реестре НСИ справочников посредством REST сервисов.

Для запуска импорта необходимо запустить соответствующую утилиту из командной строки:

* >externalimport –source rosmizdrav  - возвращает список всех имеющихся справочников
* >externalimport –source rosmizdrav OID1 OID2 – Добавляет новый справочник/версию справочника в реестр НСИ. Необходимо указать уникальный идентификатор импортируемого справочника или группы справочников. Для НСИ министерства здравоохранения подобным идентификатором выступает OID справочника. 

Например: >externalimport –source rosmizdrav 1.2.643.5.1.13.2.1.1.56 (Анатомо-терапевтическо-химическая классификация)

За раз возможно импортировать не более 10 справочников. При импорте осуществляется сопоставление версий справочников. Если в реестре НСИ есть справочник  с более поздней версией, импорт не производится.

**Просмотр информации о результатах выполнения импорта**

Необходимо выводить в лог следующую информацию:

* о начале работы,
* о завершении работы
* о статусе завершения работы (с ошибками или нет).

**Обработка исключительных ситуаций:**

* Если программа не смогла распознать введенные параметры или параметры введены некорректно, то команда не выполняется.
*  Если невозможно к базе данных или невозможно найти в ней нужную таблицу, импорт не производится  
* В случае возникновения выше и иных ошибок, они выводятся в лог стандартным для системы способом.

Интеграция с сервисом НСИ системы здравоохранения реализуется посредством указанных ниже методов:

**getRefbookList**** (*****userKey*****).**Возвращает список справочников, на которые подписан пользователь. В случае отсутствия информации о подписках возвращается ошибка.Входные данные :** **userKey – уникальный идентификатор пользователя;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.

** ****2.       ****getVersionList******(*userKey**,**refbookCode*). Возвращает список версий выбранного справочника. В случае отсутствия информации о подписке возвращается ошибка.

Входные данные:** **userKey – уникальный идентификатор пользователя; refbookCode – кодовое наименование справочника или его OID;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.

**3.       ****getRefbook******(*userKey**, **refbookCode**, **version*). Возвращает выбранную версию справочника. В случае отсутствия версии или отсутствия информации о подписке возвращается ошибка.

Входные данные 

* userKey – уникальный идентификатор пользователя;
* refbookCode – кодовое наименование справочника или его OID;
* version – номер версии справочника;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.

**4.       ****getRefbookParts******(*userKey**, **refbookCode**, **version*). Возвращает число частей выбранной версии справочника. Одна часть содержит 500 записей. В случае отсутствия версии или отсутствия информации о подписке возвращается ошибка.

Входные данные 

* userKey – уникальный идентификатор пользователя;
* refbookCode – кодовое наименование справочника или его OID;
* version – номер версии справочника;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.** **

**5.       ****getRefbookPartial **(*userKey, refbookCode, version, partNumber*). Возвращает указанную часть выбранной версии справочника. В случае некорректного указания части, отсутствия версии или отсутствия информации о подписке возвращается ошибка.

Входные данные 

* userKey – уникальный идентификатор пользователя;
* refbookCode – кодовое наименование справочника или его OID;
* version – номер версии справочника;
* partNumber – порядковый номер части справочника, начиная с 1;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.

** ****6.       ****getRefbookUpdate **(*userKey, refbookCode, userVersion, newVersion*).  Возвращает изменения между двумя версиями справочника. Если опустить конечную версию, будет использована последняя версия. Если опустить начальную версию, будет использована информация о версии пользователя, сохранённая на сервере. В случае отсутствия изменений или отсутствия информации о подписке возвращается ошибка.

Входные данные 

* userKey – уникальный идентификатор пользователя;
* refbookCode – кодовое наименование справочника или его OID;
* userVersion – начальный номер версии справочника, номер версии пользователя;
* newVersion – конечный номер версии справочника, последняя версия;

Выходные данные: Многомерный массив / объект типа ArrayOfMap.

 

**Структура упорядоченного ****xml****-файла**

 

Существует два варианта структуры xml -файла, получаемого из Реестра НСИ. Для файлов, получаемых в архиве, а также для всех методов сервиса, кроме метода *getRefbookList* , используется одна общая структура (листинг 1). Отдельные элементы структуры могут присутствовать или отсутствовать в зависимости от вызываемого запроса. Блок с ошибками может присутствовать в любом запросе.

**Листинг 1**

<book>

**     <!-- Список ошибок -->**

<errors>

<error code="**Код ошибки**">**Текст ошибки**</error>

...

</errors>

 

**     <!-- Информация о справочнике -->**

<properties>

<name>**Название справочника**</name>

<version number="**Номер версии**" date="**Дата выхода версии**"/>

<parts>**Количество частей справочника**</parts>

</properties>

 

**     <!-- Список версий -->**

<versions>

<version number="**Номер версии**" date="**Дата выхода версии**"/>

...

</versions>

 

**     <!-- ****Записи**** -->**

<entries>

<entry>

**<column1>value1</column1>**

**<column2>value2</column2>**

...

</entry>

...

</entries>

</book>

 

При выгрузке списка справочников методом *getRefbookList* структура несколько отличается (листинг 2).

**Листинг 2**

<books>

**     <!-- Список ошибок -->**

<errors>

<error code="**Код ошибки**">**Текст ошибки**</error>

...

</errors>

 

**     <!-- Список справочников -->**

<book>

<code>**Код справочника**</code>

<name>**Название справочника**</name>

<description>**Описание справочника**</description>

</book>

...

</books>

 

