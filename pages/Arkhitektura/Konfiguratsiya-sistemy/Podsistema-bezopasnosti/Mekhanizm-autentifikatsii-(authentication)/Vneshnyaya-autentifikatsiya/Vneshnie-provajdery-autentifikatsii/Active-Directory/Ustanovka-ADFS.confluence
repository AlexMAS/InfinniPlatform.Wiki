---
layout: default
title: Установка ADFS
position: 0
categories: 
tags: 
---

<ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">1. Создание учетной записи службы ADFS</ac:parameter><ac:rich-text-body><p>Создать&nbsp;учетную запись пользователя домена или групповую учетную запись, от имени которой будет работать служба ADFS.</p><p>&nbsp;</p><ac:structured-macro ac:name="code"><ac:parameter ac:name="title">Пример</ac:parameter><ac:plain-text-body><![CDATA[INFINNITY\adfs-svc]]></ac:plain-text-body></ac:structured-macro><pre>     </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">2. Установка и настройка хранилища данных службы ADFS</ac:parameter><ac:rich-text-body><p>Служба ADFS в качестве хранилища может использовать&nbsp;<a href="http://technet.microsoft.com/en-us/library/cc754405.aspx">WID (Windows Internal Database)</a>&nbsp;или MS SQL Server. Соответственно перед установкой ADFS нужно создать и/или настроить либо то, либо другое. С точки зрения администрирования гораздо проще и удобней использовать обычный MS SQL Server. Если было принято хранить данные в MS SQL Server, нужно убедиться, что сервер базы данных доступен со стороны&nbsp;сервера ADFS для учетной записи службы. То же самое требование касается учетной записи, от имени которой будет устанавливаться служба ADFS.</p><p>&nbsp;</p><ac:structured-macro ac:name="panel"><ac:parameter ac:name="bgColor">transparent</ac:parameter><ac:parameter ac:name="title">Пример</ac:parameter><ac:parameter ac:name="borderStyle">dashed</ac:parameter><ac:rich-text-body><p><ac:image><ri:attachment ri:filename="AdfsUser_01.png" /></ac:image></p><p><ac:image><ri:attachment ri:filename="AdfsUser_02.png" /></ac:image></p></ac:rich-text-body></ac:structured-macro><pre>     </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">3. Установка сертификата аутентификации службы ADFS</ac:parameter><ac:rich-text-body><p>Служба ADFS использует HTTPS, соответственно нуждается в установке сертификата для аутентификации сервера ADFS со стороны клиента. Сертификат должен быть выдан центром сертификации, который является доверенным (Trusted Root Certification Authorities) для всех участников взаимодействия.&nbsp;<span style="color: rgb(83,83,83);">Разумеется, лучше использовать коммерческий сертификат, но работать будет и сертификат, выданный&nbsp;<a href="http://technet.microsoft.com/en-us/library/cc770357(v=ws.10).aspx">корпоративным центром сертификации</a>. Работать также будет и самоподписанный (<span>self-signed</span>) сертификат, однако его нужно будет установить в &quot;Trusted Root Certification Authorities&quot; на все машины участников взаимодействия.</span></p><p>Общее имя сертификата (Common Name, CN) должно совпадать с доменным именем, по которому будут доступны сервисы ADFS. Например, если сервисы ADFS будут доступны по адресу &quot;<span class="nolink"><span class="nolink">https://sso.infinnity.lan</span></span>&quot;, то на сервере ADFS нужно установить сертификат, у которого &quot;CN=<span class="nolink">sso.infinnity.lan</span>&quot;. Если сервисы ADFS доступны не только по адресу&nbsp;&quot;<span class="nolink"><span class="nolink">https://sso.infinnity.lan</span></span>&quot;, то сертификат должен содержать список всех&nbsp;<a href="http://en.wikipedia.org/wiki/SubjectAltName">альтернативных имен</a>&nbsp;(Subject Alternative&nbsp;<span class="nolink">Name</span>, SAN), например: &quot;DNS.1=sso.infinnity.lan,DNS.2=sso2.infinnity.lan&quot;;&nbsp;либо содержать&nbsp;wildcard в общем имени, например: &quot;CN=*.infinnity.lan&quot;. Естественно, что первый способ (SAN) является правильным, а второй способ (wildcard) - наиболее простым. Дополнительные&nbsp;требования к сертификату службы приведены в разделе &quot;<a href="http://technet.microsoft.com/en-us/library/hh341473.aspx">Service Communications Certificates</a>&quot;.</p><p>&nbsp; &nbsp;</p><ac:structured-macro ac:name="warning"><ac:parameter ac:name="title">Важно</ac:parameter><ac:rich-text-body><p>Общее имя сертификата (Common Name, CN)&nbsp;не должно совпадать с именем сервера ADFS. Например, если сервер ADFS доступен по имени &quot;adfs.infinnity.lan&quot;, то это имя нельзя использовать в качестве имени службы ADFS. Эту проблему можно решить, добавив DNS-синоним для сервера ADFS, например, &quot;sso.infinnity.lan&quot;, после чего установить на этот сервер сертификат, у которого &quot;CN=<span class="nolink">sso.infinnity.lan</span>&quot;.</p></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="tip"><ac:parameter ac:name="title">Пример</ac:parameter><ac:rich-text-body><p>К данной статье прикреплен пример <span style="color: rgb(83,83,83);">самоподписанного </span>wildcard-сертификата <span>&quot;CN=*.infinnity.lan&quot; (см. <ac:link><ri:attachment ri:filename="star.infinnity.lan.pfx" /></ac:link>). Пароль для установки сертификата: &quot;<span>infinnity</span>&quot;.</span></p></ac:rich-text-body></ac:structured-macro><p>&nbsp; &nbsp;</p><p>Ниже приведена последовательность шагов установки сертификата службы на сервере ADFS:</p><ul><li>Запустить &quot;MMC&quot; от имени администратора: Run / mmc / Enter</li><li>Добавить оснастку &quot;Certificates&quot;: File / Add or Remove Snap-ins / Certificates / Add / Computer account</li><li>Импортировать сертификат в &quot;Personal&quot;: Certificates / Personal / All Tasks / Import</li><li>Импортировать сертификат в &quot;<span style="color: rgb(83,83,83);">Trusted Root Certification Authorities</span>&quot;:&nbsp;Certificates /&nbsp;<span style="color: rgb(83,83,83);">Trusted Root Certification Authorities</span>&nbsp;/ All Tasks / Import</li></ul><p>&nbsp;</p></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">4. Установка роли ADFS</ac:parameter><ac:rich-text-body><p>Для установки роли ADFS на сервере нужно выполнить PowerShell-команду с правами локального администратора:</p><p>&nbsp;</p><ac:structured-macro ac:name="code"><ac:parameter ac:name="title">Пример</ac:parameter><ac:parameter ac:name="language">text</ac:parameter><ac:plain-text-body><![CDATA[import-module servermanager
Add-WindowsFeature ADFS-Federation]]></ac:plain-text-body></ac:structured-macro><pre>     </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">5. Установка службы ADFS</ac:parameter><ac:rich-text-body><p>Если после установки роли ADFS запустить &quot;Server Manager&quot;, то он выдаст предупреждение, что служба ADFS не настроена. Открыв это предупреждение, в колонке &quot;Actions&quot; будет ссылка, по нажатию на которую запускается мастер настройки службы ADFS. (К сожалению, другого способа запуска этого мастера не нашлось.) Ниже наглядно показан процесс настройки службы ADFS с помощью мастера в Windows Server 2012 R2.</p><p>&nbsp;</p><p>1.&nbsp;Окно приветствия.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_01.png" /></ac:image></p><p>&nbsp;</p><p>2. Указать учетные данные &quot;Администратора домена&quot;.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_02.png" /></ac:image></p><p>&nbsp;</p><p>3. Выбрать сертификат аутентификации и указать имя <span>службы ADFS (отличное от имени сервера ADFS).</span></p><p><ac:image><ri:attachment ri:filename="InstallAdfs_03.png" /></ac:image></p><p>&nbsp;</p><p>4. Указать учетную запись, от имени которой будет работать служба ADFS.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_04.png" /></ac:image></p><p>&nbsp;</p><p>5. Выбрать хранилище данных службы ADFS.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_05.png" /></ac:image></p><p>&nbsp;</p><p>6. Убедиться, что предварительная проверка выполнена успешно.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_06.png" /></ac:image></p><p>&nbsp;</p><p>7. Убедиться, что служба настроена успешно.</p><p><ac:image><ri:attachment ri:filename="InstallAdfs_07.png" /></ac:image></p><pre>     </pre></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="expand"><ac:parameter ac:name="title">6. Проверка доступности службы ADFS</ac:parameter><ac:rich-text-body><p>Если служба была настроена корректно, то всем участникам взаимодействия должен быть доступен диалог входа, расположенный по адресу &quot;<span class="nolink">https://&lt;&lt;ADFS&gt;&gt;/adfs/ls/IdpInitiatedSignon.aspx</span>&quot;, где &quot;<span>&lt;&lt;ADFS&gt;&gt;</span>&quot; - имя службы ADFS, указанное при установке (например, &quot;<span class="nolink">https://sso.infinnity.lan/adfs/ls/IdpInitiatedSignon.aspx</span>&quot;). В качестве теста работоспособности нужно нажать кнопку входа и ввести учетные данные пользователя домена (можно попытаться зайти под своей учетной записью). Если на странице входа появится сообщение, что вы успешно выполнили вход в систему, значит, служба работает корректно. При возникновении любых проблем в первую очередь следует убедиться, что <span>выполнены </span>все вышеуказанные шаги, после чего в &quot;Server Manager&quot; проверить журнал событий (Events) службы ADFS и системный журнал событий (eventvwr).</p><p>&nbsp;</p><p><ac:image><ri:attachment ri:filename="AdfsSignOnPage.png" /></ac:image></p><pre>     </pre></ac:rich-text-body></ac:structured-macro><p>&nbsp;</p><p>&nbsp;</p>